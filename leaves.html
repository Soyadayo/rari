<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seasons of Civilization</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #87CEEB 0%, #98FB98 100%);
            font-family: 'Georgia', serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        #gameCanvas {
            display: block;
            cursor: crosshair;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        #top-ui {
            position: absolute;
            top: 15px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 10;
            gap: 15px;
        }

        #ui {
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            font-size: 14px;
            color: #2F4F4F;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        #phase-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            font-size: 14px;
            color: #2F4F4F;
            max-width: 300px;
            flex-shrink: 0;
        }

        #story-panel {
            position: absolute;
            top: 80px;
            right: 20px;
            color: #2F4F4F;
            font-size: 13px;
            z-index: 10;
            background: rgba(255, 248, 220, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            max-width: 320px;
            border-left: 4px solid #DAA520;
            font-style: italic;
            line-height: 1.4;
        }

        .phase-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 8px;
            color: #8B4513;
        }

        .story-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            color: #8B4513;
            font-style: normal;
        }

        #season-indicator {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        #music-controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        #music-toggle {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        #music-toggle:hover {
            background: #45a049;
        }

        #music-toggle.muted {
            background: #f44336;
        }

        #music-info {
            font-size: 10px;
            color: #666;
            text-align: center;
        }

        #help-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-block;
            margin-top: 4px;
        }

        #help-button:hover {
            background: #1976D2;
        }

        #challenge-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            font-size: 12px;
            color: #2F4F4F;
            max-width: 280px;
            border-left: 4px solid #FF6B35;
        }

        .challenge-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            color: #FF6B35;
        }

        .challenge-progress {
            background: #f0f0f0;
            border-radius: 10px;
            height: 8px;
            margin: 4px 0;
            overflow: hidden;
        }

        .challenge-progress-bar {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        #event-notification {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            z-index: 100;
            display: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            max-width: 400px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .event-drought { background: linear-gradient(135deg, #FF6B35, #F7931E); }
        .event-storm { background: linear-gradient(135deg, #4A90E2, #357ABD); }
        .event-blessing { background: linear-gradient(135deg, #7ED321, #4A90E2); }

        #achievements-panel {
            position: absolute;
            top: 200px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            font-size: 11px;
            color: #2F4F4F;
            max-width: 250px;
            border-left: 4px solid #FFD700;
        }

        .achievement {
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }

        .achievement.completed {
            color: #4CAF50;
            font-weight: bold;
        }

        .achievement.completed::before {
            content: "‚úì ";
            color: #4CAF50;
        }

        .ui-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .ui-stat-label {
            font-size: 11px;
            color: #666;
            font-weight: bold;
        }

        .ui-stat-value {
            font-size: 14px;
            color: #2F4F4F;
            font-weight: bold;
        }

        .prosperity-stats {
            display: flex;
            gap: 8px;
            font-size: 11px;
        }

        .prosperity-high { color: #228B22; }
        .prosperity-medium { color: #DAA520; }
        .prosperity-low { color: #B8860B; }
        .prosperity-poor { color: #8B4513; }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="top-ui">
        <div id="ui">
            <div class="ui-stat">
                <div class="ui-stat-label">LEAVES</div>
                <div class="ui-stat-value" id="leafCount">0</div>
            </div>
            <div class="ui-stat">
                <div class="ui-stat-label">LEVEL</div>
                <div class="ui-stat-value"><span id="phase">1</span>/10</div>
            </div>
            <div class="ui-stat">
                <div class="ui-stat-label">POPULATION</div>
                <div class="ui-stat-value" id="population">0</div>
            </div>
            <div class="ui-stat">
                <div class="ui-stat-label">REGIONS</div>
                <div class="prosperity-stats">
                    <span class="prosperity-high">‚óè<span id="thrivingRegions">0</span></span>
                    <span class="prosperity-medium">‚óè<span id="growingRegions">0</span></span>
                    <span class="prosperity-low">‚óè<span id="strugglingRegions">0</span></span>
                    <span class="prosperity-poor">‚óè<span id="abandonedRegions">0</span></span>
                </div>
            </div>
        </div>
        
        <div id="music-controls">
            <button id="music-toggle">üéµ Music ON</button>
            <div id="music-info">Track 1 of 8</div>
            <a href="https://www.tacorari.eu/leavesex.html" target="_blank" id="help-button">üìñ How to Play</a>
        </div>
        
        <div id="phase-info">
            <div class="phase-title" id="phaseTitle">Primitive Age</div>
            <div id="phaseDescription">Gather leaves to create the first settlements</div>
        </div>
    </div>

    <div id="story-panel">
        <div class="story-title">Village Tales</div>
        <div id="storyText">The first humans look up at the falling leaves, wondering if they might be gifts from the sky...</div>
    </div>

    <div id="season-indicator">
        <span id="seasonName">Spring</span> üå∏
    </div>

    <div id="challenge-panel">
        <div class="challenge-title">Current Challenge</div>
        <div id="challenge-text">Reach 100 population in 60 seconds</div>
        <div class="challenge-progress">
            <div class="challenge-progress-bar" id="challenge-progress" style="width: 0%"></div>
        </div>
        <div id="challenge-timer">Time: 60s</div>
    </div>

    <div id="achievements-panel">
        <div class="challenge-title">üèÜ Achievements</div>
        <div id="achievements-list">
            <div class="achievement" id="achievement-first-leaf">Collect your first leaf</div>
            <div class="achievement" id="achievement-100-pop">Reach 100 population</div>
            <div class="achievement" id="achievement-fast-growth">Reach 500 pop in 2 minutes</div>
            <div class="achievement" id="achievement-survive-drought">Survive a drought</div>
            <div class="achievement" id="achievement-all-regions">Have all regions thriving</div>
            <div class="achievement" id="achievement-1000-leaves">Collect 1000 leaves total</div>
        </div>
    </div>

    <div id="event-notification">
        <div id="event-text">üå™Ô∏è Storm Warning!</div>
        <div id="event-description">Strong winds will scatter your leaves!</div>
    </div>

    <script>
        try {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas to full window size
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            let gameState = {
                leafCount: 0,
                totalLeavesCollected: 0,
                phase: 1,
                population: 0,
                windX: 0,
                windY: 0,
                mouseX: canvas.width / 2,
                mouseY: canvas.height / 2,
                time: 0,
                season: 0,
                storyTimer: 0,
                currentStoryIndex: 0,
                musicEnabled: true,
                currentTrack: 1,
                currentChallenge: null,
                challengeStartTime: 0,
                challengeTimeLimit: 60,
                currentEvent: null,
                eventStartTime: 0,
                eventDuration: 0,
                achievements: {
                    'first-leaf': false,
                    '100-pop': false,
                    'fast-growth': false,
                    'survive-drought': false,
                    'all-regions': false,
                    '1000-leaves': false
                }
            };

            let currentAudio = null;
            const musicTracks = [
                'https://github.com/Soyadayo/Mappon/raw/main/lmusic1.mp3',
                'https://github.com/Soyadayo/Mappon/raw/main/lmusic2.mp3',
                'https://github.com/Soyadayo/Mappon/raw/main/lmusic3.mp3',
                'https://github.com/Soyadayo/Mappon/raw/main/lmusic4.mp3',
                'https://github.com/Soyadayo/Mappon/raw/main/lmusic5.mp3',
                'https://github.com/Soyadayo/Mappon/raw/main/lmusic6.mp3',
                'https://github.com/Soyadayo/Mappon/raw/main/lmusic7.mp3',
                'https://github.com/Soyadayo/Mappon/raw/main/lmusic8.mp3'
            ];

            const seasons = [
                { name: "Spring", emoji: "üå∏", leafSpawnRate: 600, leafColors: ['#90EE90', '#98FB98', '#8FBC8F'], windMultiplier: 1.2 },
                { name: "Summer", emoji: "‚òÄÔ∏è", leafSpawnRate: 1000, leafColors: ['#228B22', '#32CD32', '#006400'], windMultiplier: 0.8 },
                { name: "Autumn", emoji: "üçÇ", leafSpawnRate: 300, leafColors: ['#FF6347', '#FF4500', '#DAA520', '#CD853F'], windMultiplier: 1.5 },
                { name: "Winter", emoji: "‚ùÑÔ∏è", leafSpawnRate: 1500, leafColors: ['#F0F8FF', '#E6E6FA', '#D3D3D3'], windMultiplier: 2.0 }
            ];

            const phases = [
                { name: "Primitive Age", description: "Gather leaves to create the first settlements", leafRequirement: 0 },
                { name: "Agricultural Dawn", description: "First farms emerge from the earth", leafRequirement: 25 },
                { name: "Village Formation", description: "Small communities take root", leafRequirement: 60 },
                { name: "Farming Expansion", description: "Crops flourish across the land", leafRequirement: 120 },
                { name: "Town Emergence", description: "Trade begins between settlements", leafRequirement: 250 },
                { name: "Industrial Awakening", description: "Technology begins to develop", leafRequirement: 400 },
                { name: "Urban Development", description: "Great cities rise from the earth", leafRequirement: 650 },
                { name: "Industrial Revolution", description: "Machines transform society", leafRequirement: 950 },
                { name: "Modern Civilization", description: "Advanced technological society", leafRequirement: 1400 },
                { name: "Eco-Future Utopia", description: "Perfect harmony with nature", leafRequirement: 2000 }
            ];

            const stories = {
                1: ["Elder Grok notices that leaves fall in patterns. He wonders if the wind spirits are trying to tell them something..."],
                2: ["Farmer Bram's wife is furious - he spent all morning watching leaves fall instead of tending the wheat!"],
                3: ["Blacksmith Henrik complains that too many leaves clog his forge, but his apprentice thinks they're beautiful."],
                4: ["Merchant Aldric refuses to trade with farms that have 'too few leaves,' claiming their produce is inferior."],
                5: ["Mayor Davidson's controversial decision to redirect leaf-fall to wealthy districts causes protests."],
                6: ["Factory owner Carnegie refuses to build in areas with low leaf-fall, believing it affects productivity."],
                7: ["City planner Morrison's grand vision is undermined by the reality that some districts never prosper."],
                8: ["Railroad baron Huntington's train routes mysteriously follow the ancient patterns of leaf distribution."],
                9: ["Tech mogul Harrison's algorithms predict city growth patterns based on historical leaf-fall data."],
                10: ["In the perfect eco-city, AI systems ensure that every district receives optimal leaf distribution."]
            };

            const challenges = [
                { text: "Reach 100 population in 60 seconds", target: 100, timeLimit: 60, type: 'population' },
                { text: "Collect 50 leaves in 45 seconds", target: 50, timeLimit: 45, type: 'leaves' },
                { text: "Get 3 thriving regions in 90 seconds", target: 3, timeLimit: 90, type: 'thriving' }
            ];

            const events = [
                { name: "Drought", emoji: "üåµ", description: "Leaf spawning reduced!", effect: { leafSpawnMultiplier: 0.3, windMultiplier: 0.5 }, duration: 20000, probability: 0.15 },
                { name: "Storm", emoji: "üå™Ô∏è", description: "Strong winds everywhere!", effect: { leafSpawnMultiplier: 2.0, windMultiplier: 3.0 }, duration: 15000, probability: 0.20 },
                { name: "Nature's Blessing", emoji: "üåü", description: "Nature smiles upon you!", effect: { leafSpawnMultiplier: 3.0, windMultiplier: 1.5 }, duration: 25000, probability: 0.10 }
            ];

            let leaves = [];
            let regions = [];
            let leafSpawnInterval;

            function playMusic() {
                if (!gameState.musicEnabled) return;
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                currentAudio = new Audio(musicTracks[gameState.currentTrack - 1]);
                currentAudio.volume = 0.6;
                currentAudio.loop = false;
                currentAudio.addEventListener('ended', () => {
                    gameState.currentTrack = (gameState.currentTrack % 8) + 1;
                    updateMusicInfo();
                    playMusic();
                });
                currentAudio.play().catch(() => {});
            }

            function toggleMusic() {
                gameState.musicEnabled = !gameState.musicEnabled;
                const button = document.getElementById('music-toggle');
                if (gameState.musicEnabled) {
                    button.textContent = 'üéµ Music ON';
                    button.classList.remove('muted');
                    playMusic();
                } else {
                    button.textContent = 'üîá Music OFF';
                    button.classList.add('muted');
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio = null;
                    }
                }
            }

            function updateMusicInfo() {
                document.getElementById('music-info').textContent = `Track ${gameState.currentTrack} of 8`;
            }

            function startNewChallenge() {
                const challenge = challenges[Math.floor(Math.random() * challenges.length)];
                gameState.currentChallenge = challenge;
                gameState.challengeStartTime = gameState.time;
                document.getElementById('challenge-text').textContent = challenge.text;
                document.getElementById('challenge-timer').textContent = `Time: ${challenge.timeLimit}s`;
                document.getElementById('challenge-progress').style.width = '0%';
            }

            function updateChallenge() {
                if (!gameState.currentChallenge) return;
                const timeElapsed = Math.floor((gameState.time - gameState.challengeStartTime) / 60);
                const timeRemaining = Math.max(0, gameState.currentChallenge.timeLimit - timeElapsed);
                document.getElementById('challenge-timer').textContent = `Time: ${timeRemaining}s`;
                
                let progress = 0;
                const challenge = gameState.currentChallenge;
                if (challenge.type === 'population') {
                    progress = Math.min(100, (gameState.population / challenge.target) * 100);
                } else if (challenge.type === 'leaves') {
                    progress = Math.min(100, (gameState.leafCount / challenge.target) * 100);
                } else if (challenge.type === 'thriving') {
                    const thrivingCount = regions.filter(r => r.prosperity === 3).length;
                    progress = Math.min(100, (thrivingCount / challenge.target) * 100);
                }
                document.getElementById('challenge-progress').style.width = progress + '%';
                
                if (progress >= 100 || timeRemaining <= 0) {
                    setTimeout(startNewChallenge, 3000);
                    gameState.currentChallenge = null;
                }
            }

            function getEventEffects() {
                if (!gameState.currentEvent) return { leafSpawnMultiplier: 1.0, windMultiplier: 1.0 };
                return gameState.currentEvent.effect;
            }

            function showEventNotification(title, description, className) {
                const notification = document.getElementById('event-notification');
                document.getElementById('event-text').textContent = title;
                document.getElementById('event-description').textContent = description;
                notification.className = className;
                notification.style.display = 'block';
                setTimeout(() => notification.style.display = 'none', 4000);
            }

            class Region {
                constructor(x, width) {
                    this.x = x;
                    this.width = width;
                    this.leafDensity = 0;
                    this.buildings = [];
                    this.prosperity = 0;
                    this.population = 0;
                }

                update() {
                    this.leafDensity = leaves.filter(leaf => leaf.landed && leaf.x >= this.x && leaf.x < this.x + this.width).length;
                    
                    if (this.leafDensity > 15) {
                        this.prosperity = 3;
                    } else if (this.leafDensity > 8) {
                        this.prosperity = 2;
                    } else if (this.leafDensity > 3) {
                        this.prosperity = 1;
                    } else {
                        this.prosperity = 0;
                    }
                    
                    this.population = Math.floor(this.leafDensity * (this.prosperity + 1) * gameState.phase);

                    // Generate buildings based on prosperity
                    const targetBuildings = this.prosperity * 3;
                    if (this.prosperity > 0 && this.buildings.length < targetBuildings) {
                        for (let i = this.buildings.length; i < targetBuildings; i++) {
                            this.buildings.push(new Building(
                                this.x + Math.random() * this.width,
                                canvas.height - 60,
                                this.prosperity
                            ));
                        }
                    }

                    // Remove buildings if prosperity drops
                    if (this.buildings.length > targetBuildings) {
                        this.buildings = this.buildings.slice(0, targetBuildings);
                    }
                }

                draw() {
                    const colors = ['#8B4513', '#CD853F', '#DAA520', '#228B22'];
                    ctx.fillStyle = colors[this.prosperity];
                    ctx.globalAlpha = 0.3;
                    ctx.fillRect(this.x, canvas.height - 60, this.width, 60);
                    ctx.globalAlpha = 1;

                    // Draw buildings
                    this.buildings.forEach(building => building.draw());
                }
            }

            class Building {
                constructor(x, y, prosperity) {
                    this.x = x;
                    this.y = y;
                    this.prosperity = prosperity;
                    this.size = 12 + prosperity * 8 + Math.random() * 6;
                    this.height = 20 + prosperity * 12 + Math.random() * 15;
                    this.color = this.getColorByProsperity();
                    this.roofColor = this.getRoofColor();
                    this.buildingType = Math.floor(Math.random() * 3);
                    this.windows = this.generateWindows();
                }

                getColorByProsperity() {
                    const prosperityColors = [
                        '#4A4A4A', // abandoned - dark gray
                        '#8B4513', // struggling - brown
                        '#CD853F', // growing - tan
                        '#F5DEB3'  // thriving - wheat
                    ];
                    return prosperityColors[this.prosperity];
                }

                getRoofColor() {
                    const roofColors = ['#8B0000', '#654321', '#2F4F4F', '#800080'];
                    return roofColors[Math.floor(Math.random() * roofColors.length)];
                }

                generateWindows() {
                    const windows = [];
                    const windowsPerRow = Math.floor(this.size / 8);
                    const rows = Math.floor(this.height / 12);
                    
                    for (let row = 0; row < rows; row++) {
                        for (let col = 0; col < windowsPerRow; col++) {
                            if (Math.random() > 0.3) {
                                windows.push({
                                    x: col * 8 + 2,
                                    y: row * 12 + 4,
                                    lit: this.prosperity > 1 && Math.random() > 0.4
                                });
                            }
                        }
                    }
                    return windows;
                }

                draw() {
                    // Building shadow
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                    ctx.fillRect(this.x - this.size/2 + 2, this.y - this.height + 2, this.size, this.height);
                    
                    // Building gradient
                    const gradient = ctx.createLinearGradient(
                        this.x - this.size/2, this.y - this.height,
                        this.x + this.size/2, this.y
                    );
                    gradient.addColorStop(0, this.adjustBrightness(this.color, 20));
                    gradient.addColorStop(0.3, this.color);
                    gradient.addColorStop(1, this.adjustBrightness(this.color, -20));
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(this.x - this.size/2, this.y - this.height, this.size, this.height);
                    
                    // Building outline
                    ctx.strokeStyle = this.adjustBrightness(this.color, -30);
                    ctx.lineWidth = 1;
                    ctx.strokeRect(this.x - this.size/2, this.y - this.height, this.size, this.height);
                    
                    // Roof
                    this.drawRoof();
                    
                    // Windows
                    this.windows.forEach(window => {
                        const windowColor = window.lit ? '#FFE135' : '#87CEEB';
                        const alpha = window.lit ? 0.9 : 0.6;
                        
                        ctx.fillStyle = windowColor;
                        ctx.globalAlpha = alpha;
                        ctx.fillRect(
                            this.x - this.size/2 + window.x,
                            this.y - this.height + window.y,
                            4, 4
                        );
                        ctx.globalAlpha = 1;
                        
                        // Window frame
                        ctx.strokeStyle = this.adjustBrightness(this.color, -40);
                        ctx.lineWidth = 0.5;
                        ctx.strokeRect(
                            this.x - this.size/2 + window.x,
                            this.y - this.height + window.y,
                            4, 4
                        );
                    });
                    
                    // Door (for prosperity > 0)
                    if (this.prosperity > 0) {
                        ctx.fillStyle = '#654321';
                        ctx.fillRect(this.x - 3, this.y - 12, 6, 12);
                        ctx.fillStyle = '#FFD700';
                        ctx.beginPath();
                        ctx.arc(this.x + 2, this.y - 6, 1, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }

                drawRoof() {
                    if (this.buildingType === 0) {
                        // Triangular roof
                        ctx.fillStyle = this.roofColor;
                        ctx.beginPath();
                        ctx.moveTo(this.x, this.y - this.height - 8);
                        ctx.lineTo(this.x - this.size/2 - 2, this.y - this.height);
                        ctx.lineTo(this.x + this.size/2 + 2, this.y - this.height);
                        ctx.closePath();
                        ctx.fill();
                        
                        // Roof highlight
                        ctx.fillStyle = this.adjustBrightness(this.roofColor, 30);
                        ctx.beginPath();
                        ctx.moveTo(this.x, this.y - this.height - 8);
                        ctx.lineTo(this.x - this.size/2 - 2, this.y - this.height);
                        ctx.lineTo(this.x, this.y - this.height);
                        ctx.closePath();
                        ctx.fill();
                    } else if (this.buildingType === 1) {
                        // Flat roof with slight overhang
                        ctx.fillStyle = this.adjustBrightness(this.roofColor, -10);
                        ctx.fillRect(this.x - this.size/2 - 1, this.y - this.height - 3, this.size + 2, 3);
                    } else {
                        // Domed roof
                        ctx.fillStyle = this.roofColor;
                        ctx.beginPath();
                        ctx.ellipse(this.x, this.y - this.height, this.size/2 + 1, 6, 0, 0, Math.PI);
                        ctx.fill();
                    }
                }

                adjustBrightness(color, amount) {
                    // Convert hex to RGB, adjust brightness, convert back
                    const hex = color.replace('#', '');
                    const r = Math.max(0, Math.min(255, parseInt(hex.substr(0, 2), 16) + amount));
                    const g = Math.max(0, Math.min(255, parseInt(hex.substr(2, 2), 16) + amount));
                    const b = Math.max(0, Math.min(255, parseInt(hex.substr(4, 2), 16) + amount));
                    return `rgb(${r}, ${g}, ${b})`;
                }
            }

            class Leaf {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = -20;
                    this.vx = (Math.random() - 0.5) * 2;
                    this.vy = Math.random() * 2 + 1;
                    this.rotation = 0;
                    this.size = Math.random() * 12 + 8;
                    this.color = seasons[gameState.season].leafColors[Math.floor(Math.random() * seasons[gameState.season].leafColors.length)];
                    this.landed = false;
                    this.alpha = 1;
                }

                update() {
                    if (!this.landed) {
                        const effects = getEventEffects();
                        this.vx += gameState.windX * 0.3 * effects.windMultiplier;
                        this.vy += 0.04;
                        this.x += this.vx;
                        this.y += this.vy;
                        this.rotation += 0.05;
                        
                        if (this.y > canvas.height - 60) {
                            this.landed = true;
                            gameState.leafCount++;
                            gameState.totalLeavesCollected++;
                            updatePhase();
                        }
                    } else {
                        this.alpha -= 0.001;
                    }
                }

                draw() {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.rotation);
                    ctx.globalAlpha = this.alpha;
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.ellipse(0, 0, this.size, this.size * 0.6, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
            }

            function updateLeafSpawning() {
                const effects = getEventEffects();
                const rate = Math.max(100, seasons[gameState.season].leafSpawnRate / effects.leafSpawnMultiplier);
                clearInterval(leafSpawnInterval);
                leafSpawnInterval = setInterval(() => {
                    if (leaves.filter(leaf => !leaf.landed).length < 20) {
                        leaves.push(new Leaf());
                    }
                }, rate);
            }

            function updateSeason() {
                gameState.season = (gameState.season + 1) % 4;
                const season = seasons[gameState.season];
                document.getElementById('seasonName').textContent = season.name;
                document.getElementById('season-indicator').innerHTML = 
                    `<span id="seasonName">${season.name}</span> ${season.emoji}`;
                
                // Update leaf spawning for new season
                updateLeafSpawning();
                
                // Show season change notification
                showEventNotification(
                    `${season.emoji} ${season.name} arrives!`,
                    `The world changes with the new season`,
                    'event-blessing'
                );
            }

            function updatePhase() {
                const nextPhase = phases[gameState.phase];
                if (nextPhase && gameState.leafCount >= nextPhase.leafRequirement) {
                    gameState.phase++;
                    updateUI();
                }
            }

            function updateUI() {
                document.getElementById('leafCount').textContent = gameState.leafCount;
                document.getElementById('phase').textContent = gameState.phase;
                
                let totalPopulation = 0;
                const prosperityCounts = [0, 0, 0, 0];
                regions.forEach(region => {
                    prosperityCounts[region.prosperity]++;
                    totalPopulation += region.population;
                });
                
                gameState.population = totalPopulation;
                document.getElementById('population').textContent = totalPopulation;
                document.getElementById('abandonedRegions').textContent = prosperityCounts[0];
                document.getElementById('strugglingRegions').textContent = prosperityCounts[1];
                document.getElementById('growingRegions').textContent = prosperityCounts[2];
                document.getElementById('thrivingRegions').textContent = prosperityCounts[3];
                
                const currentPhase = phases[gameState.phase - 1];
                if (currentPhase) {
                    document.getElementById('phaseTitle').textContent = currentPhase.name;
                    document.getElementById('phaseDescription').textContent = currentPhase.description;
                }
            }

            function drawBackground() {
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                
                // Season-specific backgrounds
                if (gameState.season === 0) { // Spring
                    gradient.addColorStop(0, '#87CEEB');
                    gradient.addColorStop(0.3, '#B0E0E6');
                    gradient.addColorStop(0.7, '#E0F6FF');
                    gradient.addColorStop(1, '#F0FFF0');
                } else if (gameState.season === 1) { // Summer
                    gradient.addColorStop(0, '#87CEFA');
                    gradient.addColorStop(0.3, '#98D8E8');
                    gradient.addColorStop(0.7, '#B8E6B8');
                    gradient.addColorStop(1, '#90EE90');
                } else if (gameState.season === 2) { // Autumn
                    gradient.addColorStop(0, '#F4A460');
                    gradient.addColorStop(0.3, '#DEB887');
                    gradient.addColorStop(0.7, '#D2B48C');
                    gradient.addColorStop(1, '#D2691E');
                } else { // Winter
                    gradient.addColorStop(0, '#B0C4DE');
                    gradient.addColorStop(0.3, '#D3D3D3');
                    gradient.addColorStop(0.7, '#E6E6FA');
                    gradient.addColorStop(1, '#F5F5F5');
                }
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            function drawGround() {
                ctx.fillStyle = '#228B22';
                ctx.fillRect(0, canvas.height - 60, canvas.width, 60);
            }

            function gameLoop() {
                gameState.time++;
                
                // Season change every 30 seconds (1800 frames at 60fps)
                if (gameState.time % 1800 === 0) {
                    updateSeason();
                }
                
                // Random events every 5 seconds
                if (gameState.time % 300 === 0 && Math.random() < 0.3) {
                    const event = events[Math.floor(Math.random() * events.length)];
                    gameState.currentEvent = event;
                    gameState.eventStartTime = gameState.time;
                    showEventNotification(`${event.emoji} ${event.name}!`, event.description, 'event-blessing');
                    updateLeafSpawning();
                }
                
                // End current event
                if (gameState.currentEvent && (gameState.time - gameState.eventStartTime) >= gameState.currentEvent.duration) {
                    gameState.currentEvent = null;
                    updateLeafSpawning();
                    showEventNotification("üå± Weather normalizes", "Natural conditions return", 'event-blessing');
                }
                
                updateChallenge();
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawBackground();
                drawGround();
                
                regions.forEach(region => {
                    region.update();
                    region.draw();
                });
                
                leaves = leaves.filter(leaf => {
                    leaf.update();
                    leaf.draw();
                    return leaf.alpha > 0;
                });
                
                gameState.windX *= 0.95;
                gameState.windY *= 0.95;
                
                updateUI();
                requestAnimationFrame(gameLoop);
            }

            window.addEventListener('resize', resizeCanvas);

            // Initialize regions with proper canvas size
            function initializeRegions() {
                regions = [];
                for (let i = 0; i < 8; i++) {
                    regions.push(new Region(i * canvas.width / 8, canvas.width / 8));
                }
            }

            initializeRegions();

            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const newMouseX = e.clientX - rect.left;
                const newMouseY = e.clientY - rect.top;
                gameState.windX = (newMouseX - gameState.mouseX) * 0.1;
                gameState.windY = (newMouseY - gameState.mouseY) * 0.1;
                gameState.mouseX = newMouseX;
                gameState.mouseY = newMouseY;
            });

            // Update resize handler to reinitialize regions
            window.addEventListener('resize', () => {
                resizeCanvas();
                initializeRegions();
            });

            document.getElementById('music-toggle').addEventListener('click', toggleMusic);
            
            updateUI();
            updateMusicInfo();
            
            // Initialize season display
            const season = seasons[gameState.season];
            document.getElementById('seasonName').textContent = season.name;
            document.getElementById('season-indicator').innerHTML = 
                `<span id="seasonName">${season.name}</span> ${season.emoji}`;
            
            startNewChallenge();
            updateLeafSpawning();
            playMusic();
            gameLoop();

        } catch (error) {
            console.error('Game initialization failed:', error);
            document.body.innerHTML = '<div style="padding: 20px; font-family: Arial; text-align: center;"><h2>üçÉ Seasons of Civilization</h2><p>Loading game...</p><p style="color: #666;">If this takes too long, please refresh the page.</p></div>';
        }
    </script>
</body>
</html>
